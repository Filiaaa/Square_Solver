/**
 * @brief including header files.
 */
#include "header.h"
#include "parsing.h"

#include "scan.h"
#include "print.h"
#include "work.h"



/**
 * @brief Very small numb for comparison.
 */

const char* using_warning_string = "Using: -t (if you want to work with console) -i <input file>-o <output file>. If you want to work with console you shouldnt write file names.\n";
const char* greeting_string = "This program finds solutions to a quadratic equation of the form ax^2 + bx + c = 0\nEnter coefficients a, b, c separated by spaces\n";



/**
 * @mainpage Square_Solver
 *
 * @section Introduction
 *
 * This program prints roots of the equantion if they exist.
 */






  /**
 * @brief Function that parse input string
 */
  /**
 * @param int argc - ammount of arguments in input string.
 * @param char* argv[] - arguments in input string.
 */
void Parsing(int argc, char* argv[]);



 /** Main function.
 *  In this function you can choose if you want to work with a file or with a console.
 */
int main(int argc, char* argv[])
{
    Parsing(argc, argv);

    return 0;
}







// TODO: add docs (doxygen) +
// TODO: add unit test    +
// TODO: read argc, argv arg_parse : task.exe -i stdin -o output.txt -t +
// TODO: function pointer (callback)


//TODO: затюнить tests так чтобы x1: x2: a: b: c: ammount:     +
//TODO: структуру флагов с короткой/длинной версией, структуру состояния, callback в структуру запихнуть   +
//TODO: сделать разбиение на файлы cpp и h
//TODO: разбить вывод correct  в тестах   +
void Flag1Func(Flag *flag, Parser *parser)
{
    parser -> work_with_console = 1;
}

void Flag2Func(Flag *flag, Parser *parser)
{

    parser -> file = fopen(flag->argument, "r");
}

void Flag3Func(Flag *flag, Parser *parser)
{
    parser -> result_file = fopen(flag->argument, "w");
}

void AnalyzeParser(Parser parser)
{
    if((parser.file != NULL || parser.result_file != NULL) && parser.work_with_console == 1)
    {
        printf("%s", using_warning_string);
        return;
    }


    if(parser.work_with_console == 1)
    {
        WorkWithConsole();
        return;
    }

    if(parser.file == NULL || parser.result_file == NULL)
    {
        printf("%s", using_warning_string);
        return;
    }
    WorkWithFile(parser.file, parser.result_file);
}

void Parsing(int argc, char* argv[])
{
    if(argc == 1)
    {
        WorkWithConsole();
        return;
    }
    Parser parser;
    Flag flag1 = {"-c", "-console", 0, "", Flag1Func};
    Flag flag2 = {"-i", "-input", 1, "", Flag2Func};
    Flag flag3 = {"-o", "-output", 1, "", Flag3Func};

    Flag flags[3] = {flag1, flag2, flag3};
    int flags_numb = 3;


    for(int i = 1; i < argc; i+=2)
    {
        printf("%s ",argv[i]);
        int has_flag = 0;
        for(int j = 0; j < flags_numb; j++)
        {
             if(strcmp(argv[i], flags[j].short_version) == 0 || strcmp(argv[i], flags[j].long_version) == 0)
             {
                if(flags[j].arguments_numb > 0)
                {
                    flags[j].argument = argv[i + 1];
                }
                else
                {
                    i -= 1; //раньше шагали через два, но тут надо через 1
                }
                flags[j].function(&flags[j], &parser);
                has_flag = 1;
                break;
             }
        }
        if(has_flag == 0)
        {
            printf("%s", using_warning_string);
            return;
        }
    }
    for(int i = 0; i < flags_numb; i ++)
    {
        printf("%d %s %s %d %s\n", i, flags[i].short_version, flags[i].long_version, flags[i].arguments_numb, flags[i].argument);
    }
    AnalyzeParser(parser);

}


